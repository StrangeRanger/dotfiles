#!/usr/bin/env bash
#
# Perform checks to identify if certain tools or components are installed. Once the checks
# are complete, the results are written to a JSON file for later use by other scripts.
#
############################################################################################
####[ Global Variables ]####################################################################


C_OS=$(uname -s)
readonly C_OS

C_YELLOW="$(printf '\033[1;33m')"
C_GREEN="$(printf '\033[0;32m')"
C_BLUE="$(printf '\033[0;34m')"
C_NC="$(printf '\033[0m')"
readonly C_YELLOW C_GREEN C_BLUE C_NC

readonly C_WARNING="${C_YELLOW}==>${C_NC} "
readonly C_SUCCESS="${C_GREEN}==>${C_NC} "
readonly C_INFO="${C_BLUE}==>${C_NC} "

# shellcheck disable=all
C_CHEZMOI_DIR={{ .chezmoi.sourceDir | quote }}
# shellcheck enable=all


####[ Main ]################################################################################


echo "${C_INFO}Running precompute script..."

###
### [ Tool Presence Checks ]
###

echo "${C_INFO}  Checking if 'git-delta' is installed..."
if command -v delta >/dev/null; then
    C_IS_DELTA_INSTALLED=true
else
    C_IS_DELTA_INSTALLED=false
fi

###
### [ GUI/Headless Environment Check ]
###

echo "${C_INFO}  Checking if GUI environment is present..."

if [[ $C_OS == "Darwin" ]]; then
    if launchctl print "gui/$(id -u)" &>/dev/null; then
        C_IS_GUI_ENVIRONMENT=true
    else
        C_IS_GUI_ENVIRONMENT=false
    fi
elif [[ $C_OS == "Linux" ]]; then
    if pgrep -x gdm >/dev/null \
        || pgrep -x lightdm >/dev/null \
        || pgrep -x sddm >/dev/null \
        || pgrep -x xorg >/dev/null \
        || pgrep -x wayland >/dev/null \
        || [[ -n $DISPLAY ]] \
        || [[ $XDG_SESSION_TYPE == "wayland" ]] \
        || [[ $XDG_SESSION_TYPE = "x11" ]]
    then
        C_IS_GUI_ENVIRONMENT=true
    else
        C_IS_GUI_ENVIRONMENT=false
    fi
else
    echo "${C_WARNING}  Unsupported operating system: $C_OS" >&2
    echo "${C_INFO}  Assuming headless environment"
    C_IS_GUI_ENVIRONMENT=false
fi

###
### [ Write Precomputed Data to File ]
###

echo "${C_INFO}  Writing precomputed data to file..."
cat > "${C_CHEZMOI_DIR}/.precomputed_data.json" <<EOF
{
    "isDeltaInstalled": $C_IS_DELTA_INSTALLED,
    "isGUIEnvironment": $C_IS_GUI_ENVIRONMENT
}
EOF

echo "${C_SUCCESS}Precompute script completed"
echo ""
